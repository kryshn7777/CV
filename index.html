<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Krishnaprasath Selvhakumar | 3D Interactive CV</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Rajdhani:wght@300;500;700&display=swap');

        body {
            margin: 0;
            overflow: hidden; /* Prevents native scroll */
            background-color: #020205;
            font-family: 'Rajdhani', sans-serif;
            color: #ffffff;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Critical: Disables browser zoom/scroll gestures */
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            background: radial-gradient(circle at center, #111520 0%, #000000 100%);
        }

        /* UI Layer */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        .header {
            pointer-events: auto;
            animation: fadeIn 2s ease-out;
            margin-top: 10px;
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #00d2ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .subtitle {
            font-family: 'Exo 2', sans-serif;
            color: #00d2ff;
            font-size: 0.9rem;
            letter-spacing: 1px;
            margin-top: 8px;
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.4);
        }

        /* Glassmorphism Panel */
        #info-panel {
            position: absolute;
            right: 40px;
            top: 50%;
            transform: translateY(-50%) translateX(120%);
            width: 400px;
            max-height: 80vh;
            background: rgba(10, 15, 25, 0.85);
            border: 1px solid rgba(0, 210, 255, 0.2);
            border-radius: 15px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            z-index: 20;
            display: flex;
            flex-direction: column;
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: auto;
        }

        #info-panel.active {
            transform: translateY(-50%) translateX(0);
        }

        .panel-header {
            background: linear-gradient(90deg, rgba(0, 210, 255, 0.1), transparent);
            padding: 15px 25px;
            border-bottom: 1px solid rgba(0, 210, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .panel-title {
            font-family: 'Exo 2', sans-serif;
            font-size: 1.3rem;
            color: #fff;
            font-weight: 600;
        }

        .panel-close {
            cursor: pointer;
            color: #00d2ff;
            font-size: 1.5rem;
            padding: 5px;
        }

        .panel-body {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1;
            scrollbar-width: thin;
            scrollbar-color: #00d2ff transparent;
        }

        .panel-body::-webkit-scrollbar { width: 4px; }
        .panel-body::-webkit-scrollbar-track { background: transparent; }
        .panel-body::-webkit-scrollbar-thumb { background: #00d2ff; border-radius: 2px; }

        .item { margin-bottom: 25px; border-left: 2px solid rgba(0, 210, 255, 0.2); padding-left: 15px; }
        .item-header { font-size: 1.1rem; font-weight: 700; color: #fff; margin-bottom: 4px; }
        .item-sub { font-size: 0.85rem; color: #88ccff; font-family: 'Exo 2', sans-serif; margin-bottom: 8px; }
        .item-desc { font-size: 0.9rem; line-height: 1.5; color: #ccc; }
        
        .tag {
            display: inline-block;
            background: rgba(0, 210, 255, 0.15);
            color: #00d2ff;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 2px;
            border: 1px solid rgba(0, 210, 255, 0.3);
        }

        .hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Exo 2', sans-serif;
            font-size: 0.8rem;
            letter-spacing: 1px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-align: center;
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .subtitle { font-size: 0.8rem; }
            
            #info-panel {
                width: 100%;
                height: 60vh;
                max-height: 60vh;
                top: auto;
                bottom: 0;
                right: 0;
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
                border-left: none;
                border-right: none;
                border-bottom: none;
            }
            
            #info-panel.active {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="header">
            <h1>Krishnaprasath S.</h1>
            <div class="subtitle">MECHATRONICS | ROBOTICS | UNREAL ENGINE</div>
        </div>
        
        <div class="hint">
            <span>DRAG TO ROTATE &bull; SCROLL/PINCH TO ZOOM &bull; TAP NODES</span>
        </div>
    </div>

    <div id="info-panel">
        <div class="panel-header">
            <div class="panel-title" id="panel-title">Section</div>
            <div class="panel-close" onclick="closePanel()">âœ•</div>
        </div>
        <div class="panel-body" id="panel-content">
            <!-- Content -->
        </div>
    </div>

    <div id="canvas-container"></div>

    <!-- Three.js & Tween.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <!-- Shaders -->
    <script type="x-shader/x-vertex" id="vertexShader">
        uniform float time;
        varying vec2 vUv;
        varying vec3 vNormal;
        varying float vDisplacement;

        vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
        vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
        vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
        float snoise(vec3 v) {
            const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
            const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
            vec3 i  = floor(v + dot(v, C.yyy) );
            vec3 x0 = v - i + dot(i, C.xxx) ;
            vec3 g = step(x0.yzx, x0.xyz);
            vec3 l = 1.0 - g;
            vec3 i1 = min( g.xyz, l.zxy );
            vec3 i2 = max( g.xyz, l.zxy );
            vec3 x1 = x0 - i1 + C.xxx;
            vec3 x2 = x0 - i2 + C.yyy;
            vec3 x3 = x0 - D.yyy;
            i = mod289(i);
            vec4 p = permute( permute( permute(
                        i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
                    + i.y + vec4(0.0, i1.y, i2.y, 1.0 ))
                    + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
            float n_ = 0.142857142857;
            vec3  ns = n_ * D.wyz - D.xzx;
            vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
            vec4 x_ = floor(j * ns.z);
            vec4 y_ = floor(j - 7.0 * x_ );
            vec4 x = x_ *ns.x + ns.yyyy;
            vec4 y = y_ *ns.x + ns.yyyy;
            vec4 h = 1.0 - abs(x) - abs(y);
            vec4 b0 = vec4( x.xy, y.xy );
            vec4 b1 = vec4( x.zw, y.zw );
            vec4 s0 = floor(b0)*2.0 + 1.0;
            vec4 s1 = floor(b1)*2.0 + 1.0;
            vec4 sh = -step(h, vec4(0.0));
            vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
            vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
            vec3 p0 = vec3(a0.xy,h.x);
            vec3 p1 = vec3(a0.zw,h.y);
            vec3 p2 = vec3(a1.xy,h.z);
            vec3 p3 = vec3(a1.zw,h.w);
            vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
            p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
            vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
            m = m * m;
            return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),
                                        dot(p2,x2), dot(p3,x3) ) );
        }

        void main() {
            vUv = uv;
            vNormal = normal;
            float noise = snoise(position * 0.5 + time * 0.4);
            vDisplacement = noise;
            vec3 newPosition = position + normal * (noise * 0.8);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        uniform float time;
        varying vec3 vNormal;
        varying float vDisplacement;

        void main() {
            vec3 colorLow = vec3(0.0, 0.2, 0.6);
            vec3 colorHigh = vec3(0.0, 0.8, 1.0);
            float mixVal = smoothstep(-1.0, 1.0, vDisplacement);
            vec3 baseColor = mix(colorLow, colorHigh, mixVal);
            vec3 viewDir = vec3(0.0, 0.0, 1.0);
            float fresnel = pow(1.0 - dot(vNormal, viewDir), 2.0);
            gl_FragColor = vec4(baseColor + fresnel * vec3(0.5, 0.8, 1.0), 0.9);
        }
    </script>

    <script>
        // --- DATA ---
        const cvData = {
            "EXPERIENCE": {
                title: "Experience",
                color: "#ff0055", 
                content: `
                    <div class="item">
                        <div class="item-header">Bheema CNC</div>
                        <div class="item-sub">Intern | Production & Quality | Aug 2023 - Dec 2023</div>
                        <div class="item-desc">
                            Operated advanced CNC/VMC machines for precision automotive parts. Conducted Pre-Delivery Inspections (PDI) ensuring strict quality adherence.
                            <br><span class="tag">CNC</span> <span class="tag">QC/QA</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">KRS Industries & Co</div>
                        <div class="item-sub">Maintenance Intern | Oct 2022 - Apr 2023</div>
                        <div class="item-desc">
                            Assisted in PLC troubleshooting and routine maintenance. Implemented preventive measures, reducing downtime by 1.2%.
                            <br><span class="tag">PLC</span> <span class="tag">Maintenance</span>
                        </div>
                    </div>
                `
            },
            "PROJECTS": {
                title: "Projects",
                color: "#00d2ff", 
                content: `
                    <div class="item">
                        <div class="item-header">Dynamic Drill</div>
                        <div class="item-sub">Robotic Parallel Manipulator</div>
                        <div class="item-desc">
                            Designed a delta robot for drilling operations. Handled kinematic simulations and frame design. <br><i>Design Patent Filed (Jan 2024).</i>
                            <br><span class="tag">Robotics</span> <span class="tag">Kinematics</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">Agri Sentry</div>
                        <div class="item-sub">Smart Agriculture Rover</div>
                        <div class="item-desc">
                            Pest detection rover using Computer Vision and pheromone traps. Modeled 3D components and developed CV algorithms.
                            <br><span class="tag">Computer Vision</span> <span class="tag">3D Modeling</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">Face Flow Safeguard</div>
                        <div class="item-sub">Contactless Attendance</div>
                        <div class="item-desc">
                            Integrated ML backend for RFID/Face recognition with thermal scanning.
                            <br><span class="tag">ML</span> <span class="tag">ESP32</span>
                        </div>
                    </div>
                `
            },
            "SKILLS": {
                title: "Skills",
                color: "#00ff88", 
                content: `
                    <div class="item">
                        <div class="item-header">Software</div>
                        <div style="margin-top:5px;">
                            <span class="tag">Unreal Engine 5</span>
                            <span class="tag">ROS 2</span>
                            <span class="tag">Matlab</span>
                            <span class="tag">AutoCAD</span>
                            <span class="tag">Catia V5</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">Languages</div>
                        <div style="margin-top:5px;">
                            <span class="tag">Python</span>
                            <span class="tag">C++</span>
                            <span class="tag">Java</span>
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">Core</div>
                        <div style="margin-top:5px;">
                            <span class="tag">Robotics</span>
                            <span class="tag">Mechatronics</span>
                            <span class="tag">Game Dev</span>
                            <span class="tag">PLC</span>
                        </div>
                    </div>
                `
            },
            "EDUCATION": {
                title: "Education",
                color: "#ffcc00", 
                content: `
                    <div class="item">
                        <div class="item-header">B.E. Mechatronics</div>
                        <div class="item-sub">Sathyabama Institute | CGPA: 8.55/10</div>
                        <div class="item-desc">Aug 2023. Encore Club Mentor.</div>
                    </div>
                    <div class="item">
                        <div class="item-header">Certifications</div>
                        <div class="item-desc">
                            <ul>
                                <li>Product Design (CADD Center)</li>
                                <li>Robotics & ROS 2 (Udemy)</li>
                                <li>ADAS (Udemy)</li>
                            </ul>
                        </div>
                    </div>
                `
            },
            "EXTRAS": {
                title: "Creative",
                color: "#aa00ff", 
                content: `
                    <div class="item">
                        <div class="item-header">Game Developer</div>
                        <div class="item-sub">2019 - Present</div>
                        <div class="item-desc">
                            Indie developer with releases on Play Store. Specialized in automotive simulation in Unreal Engine 5.
                        </div>
                    </div>
                    <div class="item">
                        <div class="item-header">Patents</div>
                        <div class="item-desc">
                            Two Design Patents filed (2024). Research presented at ICDTM (SASTRA University).
                        </div>
                    </div>
                `
            }
        };

        // --- SCENE SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 35);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- LIQUID CORE ---
        const coreGeometry = new THREE.IcosahedronGeometry(4, 3);
        const coreMaterial = new THREE.ShaderMaterial({
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent,
            uniforms: { time: { value: 0.0 } },
            transparent: true,
            side: THREE.DoubleSide
        });
        const core = new THREE.Mesh(coreGeometry, coreMaterial);
        scene.add(core);

        // --- NODES ---
        const nodes = [];
        const connectionLines = [];
        const keys = Object.keys(cvData);
        const radius = window.innerWidth < 768 ? 14 : 18;

        const group = new THREE.Group();
        scene.add(group);

        keys.forEach((key, i) => {
            const angle = (i / keys.length) * Math.PI * 2;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            const y = (Math.random() - 0.5) * 4; 

            const pivot = new THREE.Object3D();
            pivot.rotation.y = angle;
            group.add(pivot);

            const geo = new THREE.OctahedronGeometry(1.2, 0);
            const mat = new THREE.MeshStandardMaterial({
                color: cvData[key].color,
                roughness: 0.2,
                metalness: 0.8,
                emissive: cvData[key].color,
                emissiveIntensity: 0.5
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(radius, y, 0); 
            pivot.add(mesh);

            // Glow
            const spriteMat = new THREE.SpriteMaterial({
                map: createGlowTexture(cvData[key].color),
                transparent: true,
                opacity: 0.6,
                blending: THREE.AdditiveBlending
            });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(7, 7, 1);
            mesh.add(sprite);

            // Label
            const labelTex = createLabelTexture(cvData[key].title);
            const labelMat = new THREE.SpriteMaterial({ map: labelTex, transparent: true });
            const label = new THREE.Sprite(labelMat);
            label.position.y = 2.5;
            label.scale.set(6, 3, 1);
            mesh.add(label);

            nodes.push({ id: key, mesh: mesh, pivot: pivot, baseY: y, color: cvData[key].color });

            // Connection Line
            const curve = new THREE.CubicBezierCurve3(
                new THREE.Vector3(0, 0, 0),
                new THREE.Vector3(x/3, y, z/3), 
                new THREE.Vector3(x/1.5, 0, z/1.5), 
                new THREE.Vector3(x, y, z)
            );
            
            const lineGeo = new THREE.BufferGeometry().setFromPoints(curve.getPoints(20));
            const lineMat = new THREE.LineBasicMaterial({ 
                color: cvData[key].color, 
                transparent: true, 
                opacity: 0.3 
            });
            const line = new THREE.Line(lineGeo, lineMat);
            scene.add(line);
            connectionLines.push({ line: line, curve: curve, targetNode: mesh });
        });

        // --- BACKGROUND PARTICLES ---
        const particleCount = window.innerWidth < 768 ? 800 : 1500;
        const particlesGeo = new THREE.BufferGeometry();
        const particlesPos = new Float32Array(particleCount * 3);
        const particlesSpeed = [];
        
        for(let i=0; i<particleCount; i++) {
            particlesPos[i*3] = (Math.random() - 0.5) * 80;
            particlesPos[i*3+1] = (Math.random() - 0.5) * 50;
            particlesPos[i*3+2] = (Math.random() - 0.5) * 50 - 10;
            particlesSpeed.push((Math.random() * 0.05) + 0.02);
        }
        
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(particlesPos, 3));
        const particlesMat = new THREE.PointsMaterial({
            color: 0x00d2ff,
            size: 0.15,
            transparent: true,
            opacity: 0.4,
            blending: THREE.AdditiveBlending
        });
        const particleSystem = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particleSystem);

        // --- LIGHTING ---
        const ambient = new THREE.AmbientLight(0x222222);
        scene.add(ambient);
        const pointLight = new THREE.PointLight(0xffffff, 1.5, 50);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);
        const coreLight = new THREE.PointLight(0x00d2ff, 1, 30);
        core.add(coreLight);

        // --- INTERACTION LOGIC (Unified Pointer + Zoom) ---
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        
        let isDragging = false;
        let isZooming = false;
        let startX = 0, startY = 0;
        let targetRotY = 0;
        let targetRotX = 0;
        
        // Zoom Variables
        let initialPinchDistance = 0;
        const MIN_ZOOM = 12;
        const MAX_ZOOM = 80;
        const ZOOM_SPEED = 0.05; // Touch
        const WHEEL_SPEED = 0.05; // Mouse
        
        // MOUSE WHEEL ZOOM
        window.addEventListener('wheel', (e) => {
            // Prevent default page scroll if any
            e.preventDefault();
            
            // Adjust camera Z
            let newZ = camera.position.z + e.deltaY * WHEEL_SPEED * 0.1;
            camera.position.z = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZ));
        }, { passive: false });

        // Helper to get distance between two touches
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Pointer Handler
        function onPointerStart(e) {
            if (e.touches && e.touches.length === 2) {
                // Multi-touch: Start Zoom
                isZooming = true;
                isDragging = false;
                initialPinchDistance = getTouchDistance(e.touches);
            } else {
                // Single touch/mouse: Start Drag
                isDragging = true;
                isZooming = false;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX;
                startY = clientY;
            }
        }

        function onPointerMove(e) {
            // Handle Zoom (Pinch)
            if (isZooming && e.touches && e.touches.length === 2) {
                const currentDistance = getTouchDistance(e.touches);
                const delta = initialPinchDistance - currentDistance;
                
                // Adjust Zoom
                let newZ = camera.position.z + delta * ZOOM_SPEED;
                camera.position.z = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZ));
                
                initialPinchDistance = currentDistance;
                return; // Skip rotation
            }

            // Update Raycaster Pointer
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            pointer.x = (clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(clientY / window.innerHeight) * 2 + 1;

            // Handle Rotation
            if (isDragging) {
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                
                targetRotY += deltaX * 0.005;
                targetRotX += deltaY * 0.005;

                startX = clientX;
                startY = clientY;
            }
        }

        function onPointerEnd(e) {
            isDragging = false;
            // Only stop zooming if fingers lifted leaves < 2 touches
            if (e.touches && e.touches.length < 2) {
                isZooming = false;
            }
        }

        // --- LISTENERS ---
        const canvas = document.getElementById('canvas-container');
        
        canvas.addEventListener('mousedown', onPointerStart);
        canvas.addEventListener('mousemove', onPointerMove);
        window.addEventListener('mouseup', onPointerEnd);
        
        canvas.addEventListener('touchstart', onPointerStart, { passive: false });
        canvas.addEventListener('touchmove', onPointerMove, { passive: false });
        window.addEventListener('touchend', onPointerEnd);

        // Click Logic (Distinguish drag/zoom from click)
        let clickStartTime;
        canvas.addEventListener('mousedown', () => clickStartTime = Date.now());
        canvas.addEventListener('touchstart', () => clickStartTime = Date.now(), {passive:false});
        
        const onClick = () => {
            const duration = Date.now() - clickStartTime;
            // Ensure short tap and not currently zooming/dragging wildly
            if (duration < 250 && !isZooming) {
                raycaster.setFromCamera(pointer, camera);
                const meshes = nodes.map(n => n.mesh);
                const intersects = raycaster.intersectObjects(meshes);

                if (intersects.length > 0) {
                    const object = intersects[0].object;
                    const nodeData = nodes.find(n => n.mesh === object);
                    focusNode(nodeData);
                    openPanel(nodeData.id);
                }
            }
        };
        window.addEventListener('click', onClick);


        // --- ANIMATION LOOP ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            TWEEN.update();

            // Core Animation
            coreMaterial.uniforms.time.value = time;
            core.rotation.y = time * 0.1;

            // Inertia Rotation (Only when not interacting)
            if (!isDragging && !isZooming && !document.getElementById('info-panel').classList.contains('active')) {
                targetRotY += 0.0015; 
            }
            
            // Limit vertical rotation tilt
            targetRotX = Math.max(-0.5, Math.min(0.5, targetRotX));

            // Apply smooth rotation to group
            group.rotation.y += (targetRotY - group.rotation.y) * 0.08;
            group.rotation.x += (targetRotX - group.rotation.x) * 0.08;

            // Nodes & Lines Animation
            nodes.forEach((node, i) => {
                node.mesh.position.y = node.baseY + Math.sin(time * 2 + i) * 1;
                
                // Keep labels billboarding (facing camera)
                node.mesh.children.forEach(child => {
                    if (child.isSprite) {
                        // child.scale.set(...) if needed
                    }
                });

                // Bezier Lines update
                const start = new THREE.Vector3(0,0,0);
                const end = new THREE.Vector3();
                node.mesh.getWorldPosition(end);
                
                const cp1 = start.clone().lerp(end, 0.33).add(new THREE.Vector3(Math.sin(time+i)*1.5, Math.cos(time+i)*1.5, 0));
                const cp2 = start.clone().lerp(end, 0.66).add(new THREE.Vector3(Math.cos(time+i)*1.5, Math.sin(time+i)*1.5, 0));
                
                const line = connectionLines[i].line;
                const curve = connectionLines[i].curve;
                
                curve.v0 = start; curve.v1 = cp1; curve.v2 = cp2; curve.v3 = end;
                
                const points = curve.getPoints(20);
                line.geometry.setFromPoints(points);
                line.geometry.attributes.position.needsUpdate = true;
            });

            // Particles
            const positions = particleSystem.geometry.attributes.position.array;
            for(let i=0; i<particleCount; i++) {
                positions[i*3+2] += particlesSpeed[i];
                if(positions[i*3+2] > 20) positions[i*3+2] = -50;
            }
            particleSystem.geometry.attributes.position.needsUpdate = true;

            renderer.render(scene, camera);
        }

        animate();

        // --- HELPERS ---
        function focusNode(node) {
            const worldPos = new THREE.Vector3();
            node.mesh.getWorldPosition(worldPos);

            // Responsive Zoom Distance
            const dist = window.innerWidth < 768 ? 16 : 10;
            const offset = worldPos.clone().normalize().multiplyScalar(dist);
            const targetPos = worldPos.clone().add(offset).add(new THREE.Vector3(0, 2, 0));

            new TWEEN.Tween(camera.position)
                .to({ x: targetPos.x, y: targetPos.y, z: targetPos.z }, 1200)
                .easing(TWEEN.Easing.Cubic.Out)
                .onUpdate(() => camera.lookAt(worldPos))
                .start();
        }

        function openPanel(key) {
            const data = cvData[key];
            document.getElementById('panel-title').innerText = data.title;
            document.getElementById('panel-title').style.color = data.color;
            document.getElementById('panel-content').innerHTML = data.content;
            document.getElementById('info-panel').classList.add('active');
        }

        window.closePanel = function() {
            document.getElementById('info-panel').classList.remove('active');
            
            // Reset Camera
            new TWEEN.Tween(camera.position)
                .to({ x: 0, y: 0, z: 35 }, 1500)
                .easing(TWEEN.Easing.Exponential.Out)
                .start();
        }

        function createGlowTexture(color) {
            const canvas = document.createElement('canvas');
            canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createRadialGradient(32,32, 0, 32,32, 32);
            gradient.addColorStop(0, color);
            gradient.addColorStop(0.3, color);
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(canvas);
        }

        function createLabelTexture(text) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.font = "bold 44px 'Rajdhani'";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = "rgba(0,0,0,1)";
            ctx.shadowBlur = 6;
            ctx.fillText(text, 256, 64);
            return new THREE.CanvasTexture(canvas);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>